---
title: "Processing After-School Program Data"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

First, get the data from the Denver Open Data site. (Note: we can reuse this chunk of code for downloading other datasets, too.)

```{r, message=FALSE, results="hide"}
library(tidyverse)
library(rgdal)
library(gsheet)

# Function to load data from Denver Open Data shapefiles
#     input:   name of zip file (see url where data resides)
#     output:  SpatialPointsDataFrame containing the data
getOpenData <- function(zipname) {
  # Download .zip to temporary directory, then unzip.
  url <- paste("https://www.denvergov.org/media/gis/DataCatalog/", zipname, "/shape/", zipname, ".zip", sep="")
  tempDir <- tempdir()
  file <- basename(url)
  download.file(url, file)
  unzip(file, exdir = tempDir)
  
  # Read shapefile into SpatialPointsDataFrame.
  spdf <- readOGR(dsn = tempDir, zipname)
  return(spdf)
}

spdf <- getOpenData("afterschool_programs")
head(spdf)
```

Merge with manual annotations of program type (done in Google Sheets). 
Includes the same categories as Blueprint4Summer, as well as additional annotations.

```{r}
# First get the data from the google sheet:
gurl <- construct_download_url('https://docs.google.com/spreadsheets/d/1N8Mj_OzM9ogRzZtv58lBsUxFtCqLWoM7VBB25GOUxaw/edit#gid=1653444852')
a <- as.data.frame(gsheet2tbl(gurl))
head(a)

# Merge the annotations into the original data
dataAnnotated <- merge(x = spdf, y = a)

# Replace NA's by 0's in Andrew's added columns.
for (colnum in 14:29) {
  dataAnnotated@data[is.na(dataAnnotated@data[,colnum]),colnum] <- 0
}
colSums(is.na(dataAnnotated@data)) # check for any leftover NAs
```

Keep only the coordinates and useful data variables that are consistent with the ones in the Blueprint4Summer data. Rename columns to not be cut off.

```{r}
dataSmall <- dataAnnotated[, c('LOC_NAME', 'ORGANIZATI', 'mAcademic', 'mArts', 'mCooking', 'mDance', 'mDrama', 'mMusic', 'mNature', 'mSports', 'mStem', 'mGirls Program', 'DESCRIPTIO')]

# Rename columns to be simpler, full words.
colnames(dataSmall@data) <- c('LOC_NAME', 'ORGANIZATION', 'academic', 'arts', 'cooking', 'dance', 'drama', 'music', 'nature', 'sports', 'stem', 'girls_only', 'DESCRIPTION')
head(dataSmall)
```

