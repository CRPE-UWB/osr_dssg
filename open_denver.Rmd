---
title: "Census"
author: "Joe"
date: "6/25/2018"
output: html_document
---

```{r eval=FALSE}
install.packages('rgdal')
install.packages('leaflet')
install.packages('leaflet.extras')
```



```{r message=FALSE, error=FALSE}
library("rgdal")
library("leaflet")
library("tidyverse")
library("leaflet.extras")
```


```{r}
# Function to load data from Denver Open Data shapefiles
#     input:   name of zip file (see url where data resides)
#     output:  SpatialPointsDataFrame containing the shapefile data
getOpenData <- function(zipname) {
  # Download .zip to current directory, then unzip in temporary directory.
  url <- paste("https://www.denvergov.org/media/gis/DataCatalog/", zipname, "/shape/", zipname, ".zip", sep="")
  file <- basename(url)
  download.file(url, file)
  unzip(file, exdir=zipname)
  
  # Read shapefile into SpatialPointsDataFrame.
  spdf <- readOGR(dsn = zipname, zipname)
  
  # Cleanup
  unlink(zipname,recursive=TRUE)
  unlink(paste(zipname,".zip",sep=""),recursive=TRUE)
  
  return(spdf)
}
```

##Libraries##

A lot of this info is redundant, such as abbreviations, address/state/zip (which is contained in the shapefile metadata). Other info is unnecessary, such as the status (whether under construction, temporary construction, etc). We also will rename the columns to understandable names. 

```{r message=FALSE}
libraries <- getOpenData("libraries")
# only keep relevant 
libraries = libraries[,c(1,9,10,11)]
names(libraries) = c("name","patron_count","circulation_volume","sqr_feet")
libraries[["name"]] = as.character(libraries[["name"]])
libraries[["patron_count"]] = as.numeric(as.character(libraries[["patron_count"]]))
libraries[["circulation_volume"]] = as.numeric(as.character(libraries[["circulation_volume"]]))
libraries[["sqr_feet"]] = as.numeric(as.character(libraries[["sqr_feet"]]))
```

We can look at library locations and visualize their use by the area of the dots on their locations (hence the radius should be proportional to the square root). We can compare number of patrons to number of square feet.  

```{r}
normalize <- function(vec) {
  new_vec = (vec-min(vec))/(max(vec)-min(vec))
  return(new_vec)
}
```

```{r}
leaflet(libraries) %>% 
  addProviderTiles("CartoDB.Positron") %>%
  addCircleMarkers(
    radius = ~ 50*sqrt(normalize(libraries$sqr_feet)+.1),
    stroke = FALSE, fillOpacity = 1,
    color="yellow"
  ) %>%
  addCircleMarkers(
    radius = ~ 50*sqrt(normalize(libraries$patron_count)+.1),
    stroke = FALSE, fillOpacity = .5,
    color="blue"
  ) %>% addLegend(labels=c("Square Feet","Number of Patrons"),colors=c("yellow","blue"))
```

##Parks## 

```{r message=FALSE}
parks <- getOpenData("parks")
parks = parks[c(2,5,6,23)]
names(parks) = c("name","class","acres","facilities")
parks[["name"]] = as.character(parks[["name"]])
parks[["acres"]] = as.numeric(as.character(parks[["acres"]]))
```
We need more info on how they labeled the parks to say anything meaningful, but looking at just "Rec Centers", "Athletic Complexes", and "Community" parks seems to show a hole in the central North area. also, all rec centers are localized to a crescent in the north end. 

```{r}
leaflet() %>% 
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(data=parks[parks[["class"]] %in% "Recreation Center",],color="red") %>%
  addPolygons(data=parks[parks[["class"]] %in% "Athletic Complex",],color="green") %>%
  addPolygons(data=parks[parks[["class"]] %in% "Community",],color="blue") %>%
  addLegend(labels=c("Recreation Center","Athletic Complex","Community"),colors=c("red","green","blue"))
```

##Crime##

```{r}
crime <- getOpenData("crime")
# ~200 of the ~400,000 crime locations have 0 as one or both of the coordinates
crime = crime[abs(crime@coords[,1])>.01 & abs(crime@coords[,2])>.01,]
crime = crime[c(5,6)]
names(crime) <- c("crime_details","crime_type")
```

When we plot aggravated assault crimes we see again a pattern along the southwest to northeast line, along with with concentrations along main streets. There is of course also a concentration in the city center. 

```{r}
leaflet() %>% 
  addProviderTiles("CartoDB.Positron") %>%
  addCircleMarkers(data=crime[crime$crime_type=="aggravated-assault",],
    stroke = FALSE, fillOpacity = .1, radius=2,
    color="red"
  )
```

##Foreclosures##

```{r}
foreclosures <- getOpenData("foreclosures")
foreclosures = foreclosures[c(4)]
names(foreclosures) = c("year")
foreclosures[["year"]]=as.numeric(as.character(foreclosures[["year"]]))
```

We can look at foreclosures by year - here they are plotted for 2011 and on. 

```{r}
leaflet() %>% 
  addProviderTiles("CartoDB.Positron") %>%
  addCircleMarkers(data=foreclosures[foreclosures[["year"]]>2010,],
    stroke = FALSE, fillOpacity = .1, radius=2,
    color="red"
  )
```

##Child Care Facilities##

```{r}
child_care <- getOpenData("licensed_child_care_facilities")
child_care = child_care[c(2)]
names(child_care) = c("name")
child_care[["name"]] = as.character(child_care[["name"]])
```

```{r}
leaflet() %>% 
  addProviderTiles("CartoDB.Positron") %>%
  addCircleMarkers(data=child_care,
    stroke = FALSE, fillOpacity = .3, radius=3,
    color="red"
  )
```

##Police Shootings##

```{r}
police_shootings <- getOpenData("denver_police_officer_involved_shootings")
# one super big entry for no reason
police_shootings = police_shootings[abs(police_shootings@coords[,1])<1000 & abs(police_shootings@coords[,2])<1000,]
police_shootings = police_shootings[c(5,6,15,16,17,18,19,20,21)]
names(police_shootings) = c("contact_by_whom","contact_basis","gender","age","race","ethnicity","armed_with","discharged","casualty")
police_shootings[["age"]] = as.numeric(as.character(police_shootings[["age"]]))
```

Again, southwest to northeast line. 

```{r}
leaflet() %>% 
  addProviderTiles("CartoDB.Positron") %>%
  addCircleMarkers(data=police_shootings,
    stroke = FALSE, fillOpacity = 1, radius=3,
    color="red"
  )
```

##Police Stations##

```{r}
police_stations <- getOpenData("police_stations")
police_stations = police_stations[,c(3,15)]
names(police_stations) = c("name","publicly_accessible")
police_stations[["name"]]=as.character(police_stations[["name"]])
```

```{r}
leaflet() %>% 
  addProviderTiles("CartoDB.Positron") %>%
  addCircleMarkers(data=police_stations[police_stations[["publicly_accessible"]]=="NO",],
    stroke = FALSE, fillOpacity = 1, radius=3,
    color="red"
  ) %>%
  addCircleMarkers(data=police_stations[police_stations[["publicly_accessible"]]=="YES",],
    stroke = FALSE, fillOpacity = 1, radius=3,
    color="blue"
  ) %>%
  addLegend(labels=c("Publicly Accessible","Not Publicly Accessible"),colors=c("blue","red"))
```

##Hate Crimes##
```{r}
  url <- "https://www.denvergov.org/media/gis/DataCatalog/hate_crimes/BiasMotivatedCrimes.csv"
  file <- basename(url)
  download.file(url, file)
  hate_crimes <- read.csv(file)
  # Cleanup
  unlink(file)
```
```{r}
hate_crimes = hate_crimes[,c(2,4,8,10,11)]
names(hate_crimes) = c("date","case_status","bias_type","location_description","address")
hate_crimes$date=as.Date(gsub(" .*","",hate_crimes$date),"%m/%d/%Y")
```

We have to geocode these addresses, which themselves are already deidentified. 

```{r}
library(ggmap)
hate_crimes$address = paste(hate_crimes$address, "denver", "colorado", sep=", ")

for(i in 1:nrow(df)) {
  result <- geocode(hate_crimes$address[i], output="latlona", source="google")
  hate_crimes$lon[i] <- as.numeric(result[1])
  hate_crimes$lat[i] <- as.numeric(result[2])
}
```


```{r}
leaflet() %>% 
  addProviderTiles("CartoDB.Positron") %>%
  addCircleMarkers(data=hate_crimes)
```

